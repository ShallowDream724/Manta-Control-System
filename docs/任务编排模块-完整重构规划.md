# 任务编排模块 - 完整重构规划

## 🎯 **重构目标**

### **核心问题**
1. **类型定义重复冲突** - 多个文件重复定义相同类型，导致不兼容
2. **组件封装性差** - 组件间耦合度高，难以维护
3. **移动端交互粗糙** - 按钮过大，交互逻辑不符合原生习惯
4. **缺少导入导出功能** - 无法保存和分享任务编排
5. **后端集成待完善** - 前后端类型不统一

### **重构原则**
1. **统一类型定义** - 所有组件使用同一套类型
2. **高度封装** - 组件职责单一，接口清晰
3. **原生交互** - 移动端遵循iOS/Android设计规范
4. **完整功能** - 支持导入导出、验证、预览
5. **类型安全** - 前后端类型完全一致

## 🏗️ **架构设计**

### **1. 文件结构**
```
frontend/src/
├── types/
│   └── task-orchestrator.ts          # 统一类型定义
├── utils/
│   ├── task-orchestrator.ts          # 工具函数
│   ├── task-validator.ts             # 验证逻辑
│   └── task-import-export.ts         # 导入导出
├── hooks/
│   ├── useTaskEditor.ts              # 任务编辑器状态管理
│   └── useTaskValidation.ts          # 实时验证
├── components/task-orchestrator/
│   ├── TaskEditor.tsx                # 主编辑器（响应式）
│   ├── containers/                   # 容器组件
│   │   ├── StepContainer.tsx
│   │   ├── DelayContainer.tsx
│   │   ├── LoopContainer.tsx
│   │   └── SubStepContainer.tsx
│   ├── items/                        # 项目组件
│   │   ├── ActionItem.tsx
│   │   ├── TaskPreview.tsx
│   │   └── ValidationPanel.tsx
│   ├── shared/                       # 共享组件
│   │   ├── GroupActionButtons.tsx
│   │   ├── DeviceSelector.tsx
│   │   └── TimeInput.tsx
│   ├── mobile/                       # 移动端专用组件
│   │   ├── MobileTaskEditor.tsx
│   │   ├── MobileStepList.tsx
│   │   ├── MobileActionSheet.tsx
│   │   └── MobileQuickActions.tsx
│   └── dialogs/                      # 对话框组件
│       ├── ImportDialog.tsx
│       ├── ExportDialog.tsx
│       └── ValidationDialog.tsx
```

### **2. 核心类型系统**

#### **基础类型（与后端完全一致）**
```typescript
// 基础动作
interface TaskAction {
  id: string;
  deviceId: string;
  actionType: 'power' | 'state';
  value: number | boolean;
  duration: number;
  name: string;
}

// 延时动作（只支持TaskAction和DelayAction嵌套）
interface DelayAction {
  id: string;
  type: 'delay';
  name: string;
  delayMs: number;
  actions: (TaskAction | DelayAction)[];
}

// 子步骤（循环内的执行单元，不支持循环嵌套）
interface SubStep {
  id: string;
  name: string;
  actions: (TaskAction | DelayAction)[];
}

// 并行循环（不支持循环嵌套）
interface ParallelLoop {
  id: string;
  name: string;
  iterations: number;
  intervalMs: number;
  subSteps: SubStep[];
}

// 步骤（支持动作和循环并行执行）
interface Step {
  id: string;
  name: string;
  actions: (TaskAction | DelayAction)[];
  parallelLoops: ParallelLoop[];
}

// 任务
interface Task {
  id: string;
  name: string;
  steps: Step[];
  createdAt: number;
  updatedAt: number;
  version?: string;
  description?: string;
  tags?: string[];
}
```

#### **前端扩展类型**
```typescript
// 编辑器状态
interface TaskEditorState {
  currentTask: Task;
  isPreviewOpen: boolean;
  isExecuting: boolean;
  validationErrors: ValidationError[];
  selectedItemId?: string;
  editingItemId?: string;
}

// 组件Props基类
interface BaseContainerProps {
  devices: DeviceConfig[];
  groups: DeviceGroup[];
  isMobile: boolean;
  depth?: number;
}
```

### **3. 移动端交互设计**

#### **设计原则**
1. **紧凑布局** - 充分利用屏幕空间
2. **原生手势** - 支持滑动、长按等手势
3. **层级清晰** - 使用卡片和分组明确层级
4. **快速操作** - 常用功能一键直达

#### **具体设计**
```typescript
// 移动端快速操作栏
interface MobileQuickActions {
  // 底部固定工具栏，包含：
  // - 添加步骤
  // - 添加动作（设备分组）
  // - 添加延时
  // - 添加循环
}

// 移动端动作表单
interface MobileActionSheet {
  // 从底部弹出的操作表单
  // - 设备选择（分组显示）
  // - 参数设置（滑块/开关）
  // - 时间设置（数字键盘）
}

// 移动端手势支持
interface MobileGestures {
  // 左滑删除
  // 右滑编辑
  // 长按拖拽排序
  // 双击快速编辑
}
```

### **4. 导入导出功能**

#### **支持格式**
1. **JSON格式** - 完整的任务数据
2. **简化格式** - 人类可读的YAML格式
3. **模板格式** - 可复用的任务模板

#### **功能特性**
```typescript
interface ImportExportFeatures {
  // 导出功能
  exportAsJSON: (task: Task) => string;
  exportAsYAML: (task: Task) => string;
  exportAsTemplate: (task: Task) => TaskTemplate;
  
  // 导入功能
  importFromJSON: (data: string) => Task;
  importFromYAML: (data: string) => Task;
  importFromTemplate: (template: TaskTemplate) => Task;
  
  // 验证功能
  validateImportData: (data: string) => ValidationResult;
  
  // 批量操作
  exportMultipleTasks: (tasks: Task[]) => string;
  importMultipleTasks: (data: string) => Task[];
}
```

### **5. 验证系统**

#### **实时验证**
```typescript
interface ValidationSystem {
  // 结构验证
  validateTaskStructure: (task: Task) => ValidationResult;
  
  // 设备引用验证
  validateDeviceReferences: (task: Task, devices: DeviceConfig[]) => ValidationResult;
  
  // 逻辑验证
  validateTaskLogic: (task: Task) => ValidationResult;
  
  // 性能验证
  validatePerformance: (task: Task) => ValidationResult;
}
```

## 🚀 **实施计划**

### **阶段1：核心重构（优先级最高）**
1. ✅ 创建统一类型定义
2. ✅ 创建工具函数库
3. 🔄 重构所有容器组件
4. 🔄 重构TaskEditor主组件
5. ⏳ 创建验证系统

### **阶段2：移动端优化**
1. ⏳ 设计移动端交互规范
2. ⏳ 创建移动端专用组件
3. ⏳ 实现手势支持
4. ⏳ 优化移动端性能

### **阶段3：功能完善**
1. ⏳ 实现导入导出功能
2. ⏳ 创建任务模板系统
3. ⏳ 添加批量操作
4. ⏳ 完善错误处理

### **阶段4：后端集成**
1. ⏳ 统一前后端类型
2. ⏳ 实现任务执行API
3. ⏳ 添加实时状态同步
4. ⏳ 完善错误处理

## 📊 **质量标准**

### **代码质量**
- 每个文件不超过200行（动态语言）
- 每个文件夹不超过8个文件
- 组件职责单一，接口清晰
- 100%类型安全，无any类型

### **用户体验**
- 移动端操作流畅，响应时间<100ms
- 桌面端功能完整，支持键盘快捷键
- 错误提示清晰，引导用户修复
- 支持撤销重做操作

### **可维护性**
- 统一的代码风格和命名规范
- 完整的类型定义和文档
- 充分的单元测试覆盖
- 清晰的组件依赖关系

## 🎯 **成功标准**

1. **架构清晰** - 新开发者能在30分钟内理解代码结构
2. **类型安全** - 编译时零类型错误
3. **用户友好** - 移动端和桌面端都有优秀的用户体验
4. **功能完整** - 支持完整的任务编排、导入导出、验证功能
5. **性能优秀** - 大型任务（100+步骤）编辑流畅
