# 后端核心服务开发 TODO

## 1. 设备连接管理器 (DeviceConnectionManager)
### 目标
实现Arduino设备的双连接模式支持（WiFi + 串口）

### 详细需求
- **串口连接**：
  - 自动扫描可用串口
  - 智能识别Arduino板子型号（通过设备描述符和握手协议）
  - 支持热插拔检测
  - 连接状态监控和自动重连
- **WiFi连接**：
  - 扫描并连接到Arduino热点 "FishControl_WiFi"
  - 智能检测用户当前网络状态
  - 一键断开当前WiFi功能（仅限运行后端的电脑）
  - 连接稳定性监控（100小时连续工作要求）

### 技术实现
- 使用 serialport 库处理串口通信
- 使用 node-wifi 库处理WiFi连接
- 实现连接状态机，支持自动切换连接方式
- 封装统一的设备通信接口

## 2. 设备控制API (DeviceControlAPI)
### 目标
提供统一的设备控制接口，支持实时控制和任务调度

### 详细需求
- **设备控制命令**：
  - 泵控制：功率设置（0-100%，精度1%）
  - 阀控制：开关状态，定时控制（精度0.1s）
  - 支持常开/常闭模式
- **冲突处理机制**：
  - 50ms内同设备多命令只接受第一个
  - 命令队列管理
  - 设备状态锁定机制
- **安全机制**：
  - 命令参数验证
  - 设备状态检查
  - 异常处理和恢复

### API设计
```typescript
interface DeviceCommand {
  deviceId: string;
  action: 'set_power' | 'set_state' | 'timed_action';
  value: number | boolean;
  duration?: number; // 定时动作持续时间（毫秒）
}
```

## 3. 任务执行引擎 (TaskExecutionEngine)
### 目标
实现复杂任务编排的执行引擎，支持并行循环和精确时序控制

### 详细需求
- **任务解析**：
  - 解析用户编排的复杂任务结构
  - 支持步骤、并行循环、子步骤的嵌套结构
  - 验证任务合法性
- **执行调度**：
  - 0.1s精度的时序控制
  - 并行循环状态跟踪（每个循环的当前迭代次数和子步骤）
  - 动态任务状态管理
- **内存优化**：
  - 考虑Arduino内存限制，任务解析在电脑端完成
  - 只向Arduino发送瞬时控制命令
  - 实时计算下一步需要执行的动作

### 核心算法
```typescript
interface LoopState {
  loopId: string;
  currentIteration: number;
  currentSubStep: number;
  totalIterations: number;
  intervalMs: number;
  lastExecutionTime: number;
}
```

## 4. 实时通信服务 (RealtimeCommunicationService)
### 目标
提供前端与后端的实时数据同步，支持多客户端连接

### 详细需求
- **Socket.io集成**：
  - 支持1台电脑+3台手机同时连接
  - 实时设备状态广播
  - 任务执行进度同步
  - 日志实时推送
- **数据同步**：
  - 设备状态变化实时推送
  - 任务编排数据同步
  - 用户操作冲突处理
- **连接管理**：
  - 客户端连接状态监控
  - 断线重连机制
  - 连接数限制和管理

## 5. 日志系统 (LoggingSystem)
### 目标
实现三端日志收集、存储和查询系统

### 详细需求
- **日志分类**：
  - 后端日志：服务器运行状态、API调用、错误信息
  - 前端日志：用户操作、界面状态、客户端错误
  - Arduino日志：设备控制指令、硬件状态、通信记录
- **日志存储**：
  - 使用Winston进行结构化日志记录
  - SQLite数据库存储历史日志
  - 日志轮转和清理机制
- **日志查询**：
  - 按时间范围查询
  - 按日志级别过滤
  - 关键词搜索功能

## 6. 网络服务配置 (NetworkServiceConfig)
### 目标
实现mDNS和DNS支持，确保设备能够访问fish:8080

### 详细需求
- **mDNS服务**：
  - 注册fish.local域名
  - 自动服务发现
  - 跨平台兼容性
- **DNS配置**：
  - 本地DNS服务器（可选）
  - 域名解析优化
  - 网络故障处理

## 开发优先级
1. 设备连接管理器（串口部分）
2. 设备控制API基础功能
3. 实时通信服务
4. 任务执行引擎核心算法
5. 日志系统基础功能
6. WiFi连接管理
7. 网络服务配置
8. 功能完善和优化
