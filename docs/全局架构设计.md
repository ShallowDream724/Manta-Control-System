# Manta Control Ultra - 全局架构设计

## 系统整体架构

### 核心组件关系
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面      │    │   电脑后端      │    │   Arduino设备   │
│  (三端适配)     │◄──►│  (服务器模式)   │◄──►│  (WiFi+串口)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                       │                       │
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ 手机/平板/电脑  │    │ 任务编排引擎    │    │ 设备控制逻辑    │
│ fish:8080访问   │    │ WebSocket服务   │    │ 日志WiFi传输    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 关键架构原则

### 1. 三端统一设计
- **目标设备**: 手机、平板、电脑
- **访问方式**: fish:8080统一入口
- **响应式布局**: 自适应不同屏幕尺寸
- **触摸优化**: 44px最小触摸目标
- **无Emoji设计**: 使用SVG图标和图标字体

### 2. 电脑作为服务器
- **角色定位**: 电脑后端充当服务器
- **前端部署**: 同一套前端代码部署到fish:8080
- **多端访问**: 连接热点的设备都能访问
- **数据同步**: WebSocket实时同步所有客户端

### 3. Arduino绝对稳定性
- **运行时长**: 必须支持100小时连续运行
- **内存管理**: 严格防止内存泄漏和溢出
- **看门狗机制**: 自动检测和恢复异常
- **错误恢复**: 完善的异常处理和重启机制

## WiFi通信架构

### 双模式通信设计
```typescript
// Arduino通信模式
interface CommunicationMode {
  wifi: {
    enabled: true;           // WiFi永远启用
    hotspotMode: boolean;    // 热点模式
    stationMode: boolean;    // 连接模式
    httpServer: boolean;     // HTTP服务器
    logTransmission: boolean; // 日志传输
  };
  serial: {
    enabled: boolean;        // 串口可选
    baudRate: number;        // 波特率
    fallbackMode: boolean;   // 作为WiFi备用
  };
}
```

### WiFi稳定性要求
1. **内存管理**
   - 动态内存分配监控
   - 缓冲区溢出防护
   - 定期内存清理

2. **连接管理**
   - 自动重连机制
   - 连接状态监控
   - 网络异常恢复

3. **数据传输**
   - 批量命令处理
   - 日志实时传输
   - 错误状态上报

## 任务编排器架构

### 核心执行逻辑
```
任务 (Task)
├── 步骤1 (Step) ──串行──► 步骤2 (Step) ──串行──► 步骤3 (Step)
│
└── 步骤内并行执行:
    ├── 普通动作 (Actions) ──并行──┐
    ├── 循环1 (Loop) ──并行──────┤
    ├── 循环2 (Loop) ──并行──────┼──► 同时开始执行
    └── 延时动作 (Delays) ──并行──┘

循环 (Loop)
├── 子步骤1 ──串行──► 子步骤2 ──串行──► 子步骤3
│
└── 子步骤内并行执行:
    ├── 普通动作 ──并行──┐
    └── 延时动作 ──并行──┘──► 同时执行

延时动作 (Delay)
├── 延时时间: 2000ms
└── 延时后并行执行:
    ├── 普通动作 ──并行──┐
    ├── 嵌套延时 ──并行──┤──► 延时到期后同时执行
    └── 嵌套循环 ──并行──┘
```

### 嵌套延时处理
```typescript
// 延时嵌套示例
DelayAction {
  delayMs: 2000,  // 延时2秒
  actions: [
    action1,      // 2秒后执行
    action2,      // 2秒后执行
    DelayAction { // 嵌套延时
      delayMs: 1000,  // 再延时1秒 (总共3秒)
      actions: [action3, action4]
    },
    LoopAction {  // 嵌套循环
      // 2秒后开始循环
      iterations: 5,
      subSteps: [...]
    }
  ]
}
```

## 代码生成架构

### Arduino代码生成器
```typescript
interface CodeGenerator {
  // 设备配置生成
  generateDeviceConfig(devices: DeviceConfig[]): string;
  
  // WiFi配置生成
  generateWiFiConfig(wifiSettings: WiFiSettings): string;
  
  // 通信协议生成
  generateProtocolHandler(): string;
  
  // 主循环生成
  generateMainLoop(): string;
  
  // 完整代码组装
  assembleArduinoCode(): string;
}
```

### 生成器模板结构
```
arduino-templates/
├── base/
│   ├── includes.h          // 基础头文件
│   ├── wifi-setup.cpp      // WiFi初始化模板
│   ├── http-server.cpp     // HTTP服务器模板
│   └── watchdog.cpp        // 看门狗模板
├── device-control/
│   ├── pwm-control.cpp     // PWM控制模板
│   └── digital-control.cpp // 数字控制模板
└── communication/
    ├── protocol-handler.cpp // 协议处理模板
    └── log-transmitter.cpp  // 日志传输模板
```

## 日志系统架构

### 日志传输流程
```
Arduino设备 ──WiFi──► 电脑后端 ──WebSocket──► 前端界面
     │                    │                    │
     ├── 设备状态日志      ├── 日志聚合处理      ├── 实时日志显示
     ├── 命令执行日志      ├── 日志持久化        ├── 日志过滤搜索
     └── 错误异常日志      └── 日志分析统计      └── 日志导出功能
```

### 日志格式标准
```typescript
interface LogEntry {
  timestamp: number;        // 时间戳
  level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR';
  source: 'ARDUINO' | 'BACKEND' | 'FRONTEND';
  category: string;         // 日志分类
  message: string;          // 日志内容
  data?: any;              // 附加数据
  deviceId?: string;       // 设备ID
  taskId?: string;         // 任务ID
}
```

## 性能和扩展性

### 内存使用优化
1. **Arduino端**
   - 静态内存分配优先
   - 字符串常量存储在PROGMEM
   - 及时释放动态内存

2. **后端**
   - 循环状态实时计算
   - 避免任务预展开
   - 定期清理历史数据

3. **前端**
   - 虚拟滚动长列表
   - 组件懒加载
   - 状态管理优化

### 扩展性设计
1. **设备扩展**
   - 插件化设备驱动
   - 动态设备发现
   - 多Arduino支持

2. **协议扩展**
   - 版本兼容机制
   - 协议协商
   - 向后兼容

3. **功能扩展**
   - 模块化架构
   - 插件系统
   - API开放接口

## 安全性考虑

### 网络安全
1. **WiFi安全**
   - WPA2/WPA3加密
   - MAC地址过滤
   - 访问控制列表

2. **通信安全**
   - 命令签名验证
   - 防重放攻击
   - 数据完整性校验

### 系统安全
1. **权限控制**
   - 用户角色管理
   - 操作权限验证
   - 审计日志记录

2. **故障安全**
   - 紧急停止机制
   - 安全状态恢复
   - 异常状态监控

## 开发优先级

### 第一阶段：核心功能
1. ✅ 数据结构和类型定义
2. ✅ 任务编排器文档
3. 🔄 实际代码实现开始
4. 🔄 基础Arduino通信

### 第二阶段：稳定性
1. WiFi协议完善
2. 错误处理机制
3. 日志系统实现
4. 性能优化

### 第三阶段：扩展功能
1. 代码生成器
2. 多设备支持
3. 高级功能
4. 用户体验优化

## 总结

这个全局架构确保了：
1. **三端统一** - 手机、平板、电脑无缝体验
2. **绝对稳定** - Arduino 100小时连续运行
3. **灵活扩展** - 模块化设计支持功能扩展
4. **性能优化** - 内存和网络资源高效利用
5. **安全可靠** - 完善的安全和故障处理机制

现在我们有了清晰的全局视野，可以专注于任务编排器的具体实现，同时确保不会与整体架构产生冲突。
