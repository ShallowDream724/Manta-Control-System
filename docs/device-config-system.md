# 设备配置管理系统设计文档

## 系统概述

设备配置管理系统是整个项目的核心基础，负责管理用户的设备配置，为控制面板、任务编排器和Arduino代码生成器提供配置数据。

### 核心功能
- 可视化设备配置编辑
- 实时配置验证和冲突检测
- 配置导入导出
- 默认配置管理
- Arduino代码生成支持

## 设计要求

### 用户需求确认
1. **不支持批量编辑** - 单个设备逐一配置
2. **数字输入引脚** - 不需要引脚图示，但需要PWM/IO提示
3. **实时验证** - 配置修改时立即验证
4. **重置功能** - 支持重置为默认配置

### 技术要求
- 文件长度≤200行（优先）或≤400行（最大）
- 组件职责单一，接口清晰
- 支持三端响应式适配
- 实时状态反馈

## 组件架构设计

### 主要组件
```
src/components/config/
├── DeviceConfigManager.tsx     # 配置管理主界面
├── DeviceConfigCard.tsx        # 单个设备配置卡片
├── DeviceConfigForm.tsx        # 设备配置表单
├── PinSelector.tsx             # 引脚选择器
├── DeviceTypeSelector.tsx      # 设备类型选择器
├── ConfigValidator.tsx         # 配置验证器
├── ConfigImportExport.tsx      # 导入导出功能
└── DefaultConfigManager.tsx    # 默认配置管理
```

### 数据流设计
```
用户操作 → 表单组件 → 实时验证 → 状态更新 → UI反馈
    ↓
配置保存 → 本地存储 → 其他组件同步
```

## 界面设计规范

### 配置管理主界面
```
┌─────────────────────────────────────┐
│ 设备配置管理                          │
├─────────────────────────────────────┤
│ [导入配置] [导出配置] [重置默认]        │
├─────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐      │
│ │ 充气泵1      │ │ 充气泵2      │      │
│ │ 引脚: 5     │ │ 引脚: 6     │      │
│ │ PWM        │ │ PWM        │      │
│ │ [编辑]      │ │ [编辑]      │      │
│ └─────────────┘ └─────────────┘      │
│ ┌─────────────┐ ┌─────────────┐      │
│ │ 抽气泵1      │ │ 抽气泵2      │      │
│ │ 引脚: 10    │ │ 引脚: 11    │      │
│ │ PWM        │ │ PWM        │      │
│ │ [编辑]      │ │ [编辑]      │      │
│ └─────────────┘ └─────────────┘      │
│ ┌─────────────┐ ┌─────────────┐      │
│ │ 电磁阀1      │ │ 电磁阀2      │      │
│ │ 引脚: 2     │ │ 引脚: 4     │      │
│ │ Digital    │ │ Digital    │      │
│ │ [编辑]      │ │ [编辑]      │      │
│ └─────────────┘ └─────────────┘      │
└─────────────────────────────────────┘
```

### 设备配置表单
```
┌─────────────────────────────────────┐
│ 编辑设备: 充气泵1                      │
├─────────────────────────────────────┤
│ 设备名称: [充气泵1____________]        │
│ 设备类型: (•) 泵  ( ) 阀              │
│ 引脚号码: [5___] (0-99)              │
│ 信号类型: (•) PWM  ( ) Digital        │
│ 描述信息: [可选描述____________]        │
├─────────────────────────────────────┤
│ ✓ 配置有效                           │
│ ⚠ 建议: 泵类设备使用PWM引脚            │
├─────────────────────────────────────┤
│ [取消] [保存]                        │
└─────────────────────────────────────┘
```

## 验证规则设计

### 必填字段验证
- 设备名称: 非空，长度1-20字符
- 设备类型: 必须选择 'pump' 或 'valve'
- 引脚号码: 必须是0-99的整数
- 信号类型: 必须选择 'pwm' 或 'digital'

### 唯一性验证
- 设备ID: 系统内唯一
- 设备名称: 建议唯一（警告）
- 引脚号码: 必须唯一（错误）

### 逻辑验证
- 泵类设备建议使用PWM信号（警告）
- 阀类设备使用PWM信号时提示（警告）
- 引脚号码冲突时阻止保存（错误）

### 验证反馈设计
```typescript
interface ValidationResult {
  isValid: boolean;
  errors: string[];     // 阻止保存的错误
  warnings: string[];   // 不阻止保存的警告
}

// 错误示例
errors: ["引脚号码5已被设备'充气泵2'使用"]

// 警告示例  
warnings: ["泵类设备建议使用PWM信号以支持功率控制"]
```

## 状态管理设计

### 配置状态
```typescript
interface ConfigState {
  devices: DeviceConfig[];
  editingDevice: DeviceConfig | null;
  validationResults: Record<string, ValidationResult>;
  isDirty: boolean;
  isLoading: boolean;
}
```

### 操作方法
```typescript
interface ConfigActions {
  loadConfig: () => void;
  saveConfig: () => void;
  addDevice: (type: 'pwm' | 'digital') => void;
  editDevice: (deviceId: string) => void;
  updateDevice: (device: DeviceConfig) => void;
  deleteDevice: (deviceId: string) => void;
  resetToDefault: () => void;
  importConfig: (configJson: string) => void;
  exportConfig: () => string;
}
```

## 响应式适配

### 手机端 (<768px)
- 单列布局，设备卡片垂直堆叠
- 全屏模态框编辑设备
- 底部操作按钮

### 平板端 (768px-1024px)
- 双列网格布局
- 侧边栏模态框编辑设备
- 顶部操作按钮

### 桌面端 (>1024px)
- 三列网格布局
- 右侧面板编辑设备
- 工具栏操作按钮

## 数据持久化

### 本地存储
```typescript
// localStorage key
const CONFIG_STORAGE_KEY = 'fish_control_device_config';

// 存储格式
interface StoredConfig {
  version: string;
  timestamp: string;
  devices: DeviceConfig[];
}
```

### 导入导出格式
```json
{
  "version": "1.0",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "devices": [
    {
      "id": "pump1",
      "name": "充气泵1",
      "type": "pump",
      "pin": 5,
      "signalType": "pwm",
      "description": ""
    }
  ]
}
```

## 错误处理

### 用户操作错误
- 引脚冲突: 红色边框 + 错误提示
- 无效输入: 实时提示 + 禁用保存
- 导入失败: Toast通知 + 详细错误信息

### 系统错误
- 存储失败: 重试机制 + 用户提示
- 验证异常: 降级处理 + 错误上报
- 组件异常: 错误边界 + 友好提示

## 性能优化

### 渲染优化
- React.memo包装组件
- useMemo缓存计算结果
- useCallback稳定函数引用
- 虚拟滚动（设备数量>50时）

### 验证优化
- 防抖输入验证（300ms）
- 缓存验证结果
- 增量验证更新
- 异步验证处理

## 测试策略

### 单元测试
- 配置验证函数测试
- 工具函数测试
- 组件渲染测试
- 状态管理测试

### 集成测试
- 配置编辑流程测试
- 导入导出功能测试
- 响应式布局测试
- 错误处理测试

### 用户测试
- 配置编辑易用性
- 错误提示清晰度
- 三端体验一致性
- 性能响应速度

## 开发计划

### 第一天: 基础组件
- [x] 设计文档编写
- [ ] DeviceConfigManager主界面
- [ ] DeviceConfigCard卡片组件
- [ ] 基础样式和布局

### 第二天: 编辑功能
- [ ] DeviceConfigForm表单组件
- [ ] PinSelector引脚选择器
- [ ] DeviceTypeSelector类型选择器
- [ ] 实时验证逻辑

### 第三天: 高级功能
- [ ] ConfigImportExport导入导出
- [ ] DefaultConfigManager默认配置
- [ ] 错误处理和用户反馈
- [ ] 响应式适配优化

### 第四天: 测试和优化
- [ ] 单元测试编写
- [ ] 集成测试验证
- [ ] 性能优化调整
- [ ] 文档更新完善

## 成功标准

### 功能完整性
- [ ] 支持所有设备类型配置
- [ ] 实时验证和错误提示
- [ ] 配置导入导出正常
- [ ] 默认配置重置功能

### 用户体验
- [ ] 界面美观，操作直观
- [ ] 错误提示清晰友好
- [ ] 三端体验一致优化
- [ ] 响应速度<100ms

### 代码质量
- [ ] 组件职责单一清晰
- [ ] 文件长度符合规范
- [ ] 测试覆盖率>80%
- [ ] 文档完整准确
