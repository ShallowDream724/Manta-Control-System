# ä»»åŠ¡ç¼–æ’å™¨ - å‰ç«¯ç¼–è¾‘å™¨æ¨¡å—

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

å‰ç«¯ç¼–è¾‘å™¨æ¨¡å—è´Ÿè´£æä¾›ç›´è§‚ã€é«˜æ•ˆçš„ä»»åŠ¡ç¼–æ’ç•Œé¢ï¼Œæ ¸å¿ƒç‰¹ç‚¹ï¼š
1. **å¯æŠ˜å ç»“æ„** - å¾ªç¯ã€å»¶æ—¶ç­‰å®¹å™¨æ”¯æŒæŠ˜å /å±•å¼€
2. **æ¸…æ™°çš„æ“ä½œé€»è¾‘** - ç”¨æˆ·èƒ½è½»æ¾ç†è§£ä¸²è¡Œ/å¹¶è¡Œå…³ç³»
3. **åŠ¨æ€åŠ¨ä½œç”Ÿæˆ** - æ ¹æ®è®¾å¤‡é…ç½®åŠ¨æ€ç”Ÿæˆå¯ç”¨åŠ¨ä½œ
4. **ä¸¥æ ¼çš„åµŒå¥—é™åˆ¶** - å‰ç«¯ä¸æä¾›åœ¨å­æ­¥éª¤ä¸­æ·»åŠ å¾ªç¯çš„é€‰é¡¹
5. **å®æ—¶éªŒè¯** - ç¼–è¾‘è¿‡ç¨‹ä¸­å®æ—¶éªŒè¯é…ç½®åˆç†æ€§

## ç»„ä»¶æ¶æ„è®¾è®¡

### ä¸»ç¼–è¾‘å™¨ç»„ä»¶
```typescript
// ä»»åŠ¡ç¼–è¾‘å™¨ä¸»ç»„ä»¶
interface TaskEditorProps {
  task: Task | null;
  deviceConfigs: DeviceConfig[];
  onTaskChange: (task: Task) => void;
  onSave: (task: Task) => void;
}

const TaskEditor: React.FC<TaskEditorProps> = ({ task, deviceConfigs, onTaskChange, onSave }) => {
  const [editingTask, setEditingTask] = useState<Task>(task || createEmptyTask());
  const [validationErrors, setValidationErrors] = useState<string[]>([]);
  
  // åŠ¨æ€ç”Ÿæˆå¯ç”¨åŠ¨ä½œé€‰é¡¹
  const availableActions = useMemo(() => 
    generateActionOptions(deviceConfigs), [deviceConfigs]
  );
  
  return (
    <div className="task-editor">
      <TaskHeader task={editingTask} onTaskInfoChange={handleTaskInfoChange} />
      <StepList 
        steps={editingTask.steps}
        availableActions={availableActions}
        onStepsChange={handleStepsChange}
      />
      <ValidationPanel errors={validationErrors} />
      <ActionButtons onSave={() => onSave(editingTask)} />
    </div>
  );
};
```

### æ­¥éª¤åˆ—è¡¨ç»„ä»¶
```typescript
// æ­¥éª¤åˆ—è¡¨ç»„ä»¶
interface StepListProps {
  steps: Step[];
  availableActions: ActionOption[];
  onStepsChange: (steps: Step[]) => void;
}

const StepList: React.FC<StepListProps> = ({ steps, availableActions, onStepsChange }) => {
  const handleAddStep = () => {
    const newStep = createEmptyStep();
    onStepsChange([...steps, newStep]);
  };
  
  const handleStepChange = (stepIndex: number, updatedStep: Step) => {
    const newSteps = [...steps];
    newSteps[stepIndex] = updatedStep;
    onStepsChange(newSteps);
  };
  
  return (
    <div className="step-list">
      {steps.map((step, index) => (
        <StepEditor
          key={step.id}
          step={step}
          stepIndex={index}
          availableActions={availableActions}
          onStepChange={(updatedStep) => handleStepChange(index, updatedStep)}
          onDeleteStep={() => handleDeleteStep(index)}
        />
      ))}
      <AddStepButton onClick={handleAddStep} />
    </div>
  );
};
```

## æ­¥éª¤ç¼–è¾‘å™¨è®¾è®¡

### æ­¥éª¤ç¼–è¾‘ç»„ä»¶
```typescript
// æ­¥éª¤ç¼–è¾‘å™¨ç»„ä»¶
interface StepEditorProps {
  step: Step;
  stepIndex: number;
  availableActions: ActionOption[];
  onStepChange: (step: Step) => void;
  onDeleteStep: () => void;
}

const StepEditor: React.FC<StepEditorProps> = ({ 
  step, stepIndex, availableActions, onStepChange, onDeleteStep 
}) => {
  const [isExpanded, setIsExpanded] = useState(true);
  
  return (
    <div className="step-editor border rounded-lg p-4 mb-4">
      <StepHeader 
        stepIndex={stepIndex}
        stepName={step.name}
        isExpanded={isExpanded}
        onToggleExpand={() => setIsExpanded(!isExpanded)}
        onNameChange={(name) => onStepChange({...step, name})}
        onDelete={onDeleteStep}
      />
      
      {isExpanded && (
        <div className="step-content mt-4">
          {/* æ­¥éª¤å†…å¹¶è¡Œå†…å®¹åŒºåŸŸ */}
          <div className="parallel-content-notice mb-4 p-2 bg-blue-50 rounded">
            <span className="text-blue-700">
              ğŸ“‹ æ­¥éª¤å†…æ‰€æœ‰å†…å®¹å¹¶è¡Œæ‰§è¡Œï¼ˆåŒæ—¶å¼€å§‹ï¼‰
            </span>
          </div>
          
          {/* æ™®é€šåŠ¨ä½œåŒºåŸŸ */}
          <ActionSection
            title="æ™®é€šåŠ¨ä½œ"
            actions={step.actions}
            availableActions={availableActions}
            onActionsChange={(actions) => onStepChange({...step, actions})}
          />
          
          {/* å¾ªç¯åŒºåŸŸ */}
          <LoopSection
            title="å¹¶è¡Œå¾ªç¯"
            loops={step.parallelLoops}
            availableActions={availableActions}
            onLoopsChange={(loops) => onStepChange({...step, parallelLoops: loops})}
          />
        </div>
      )}
    </div>
  );
};
```

## å¾ªç¯ç¼–è¾‘å™¨è®¾è®¡

### å¯æŠ˜å å¾ªç¯ç»„ä»¶
```typescript
// å¾ªç¯ç¼–è¾‘å™¨ç»„ä»¶
interface LoopEditorProps {
  loop: ParallelLoop;
  availableActions: ActionOption[];
  onLoopChange: (loop: ParallelLoop) => void;
  onDeleteLoop: () => void;
}

const LoopEditor: React.FC<LoopEditorProps> = ({ 
  loop, availableActions, onLoopChange, onDeleteLoop 
}) => {
  const [isExpanded, setIsExpanded] = useState(false); // é»˜è®¤æŠ˜å 
  
  return (
    <div className="loop-editor border-l-4 border-green-500 pl-4 mb-4">
      <LoopHeader
        loop={loop}
        isExpanded={isExpanded}
        onToggleExpand={() => setIsExpanded(!isExpanded)}
        onLoopConfigChange={(config) => onLoopChange({...loop, ...config})}
        onDelete={onDeleteLoop}
      />
      
      {isExpanded && (
        <div className="loop-content mt-4">
          {/* å¾ªç¯é…ç½® */}
          <LoopConfiguration
            iterations={loop.iterations}
            intervalMs={loop.intervalMs}
            onConfigChange={(config) => onLoopChange({...loop, ...config})}
          />
          
          {/* å­æ­¥éª¤ä¸²è¡Œæç¤º */}
          <div className="substep-notice mb-4 p-2 bg-yellow-50 rounded">
            <span className="text-yellow-700">
              ğŸ”„ å­æ­¥éª¤ä¸²è¡Œæ‰§è¡Œï¼ˆå­æ­¥éª¤1å®Œæˆåæ‰§è¡Œå­æ­¥éª¤2ï¼‰
            </span>
          </div>
          
          {/* å­æ­¥éª¤åˆ—è¡¨ */}
          <SubStepList
            subSteps={loop.subSteps}
            availableActions={availableActions}
            onSubStepsChange={(subSteps) => onLoopChange({...loop, subSteps})}
          />
        </div>
      )}
    </div>
  );
};
```

### å­æ­¥éª¤ç¼–è¾‘å™¨
```typescript
// å­æ­¥éª¤ç¼–è¾‘å™¨ï¼ˆé€»è¾‘ä¸æ­¥éª¤ç¼–è¾‘å™¨ç›¸åŒï¼Œä½†ä¸å…è®¸æ·»åŠ å¾ªç¯ï¼‰
interface SubStepEditorProps {
  subStep: SubStep;
  subStepIndex: number;
  availableActions: ActionOption[];
  onSubStepChange: (subStep: SubStep) => void;
  onDeleteSubStep: () => void;
}

const SubStepEditor: React.FC<SubStepEditorProps> = ({ 
  subStep, subStepIndex, availableActions, onSubStepChange, onDeleteSubStep 
}) => {
  const [isExpanded, setIsExpanded] = useState(true);
  
  // è¿‡æ»¤æ‰å¾ªç¯é€‰é¡¹ï¼ˆå­æ­¥éª¤å†…ä¸å…è®¸å¾ªç¯ï¼‰
  const filteredActions = availableActions.filter(action => action.type !== 'loop');
  
  return (
    <div className="substep-editor border rounded p-3 mb-3 bg-gray-50">
      <SubStepHeader 
        subStepIndex={subStepIndex}
        subStepName={subStep.name}
        isExpanded={isExpanded}
        onToggleExpand={() => setIsExpanded(!isExpanded)}
        onNameChange={(name) => onSubStepChange({...subStep, name})}
        onDelete={onDeleteSubStep}
      />
      
      {isExpanded && (
        <div className="substep-content mt-3">
          {/* å­æ­¥éª¤å†…å¹¶è¡Œå†…å®¹åŒºåŸŸ */}
          <div className="parallel-content-notice mb-3 p-2 bg-green-50 rounded">
            <span className="text-green-700">
              ğŸ“‹ å­æ­¥éª¤å†…æ‰€æœ‰å†…å®¹å¹¶è¡Œæ‰§è¡Œ
            </span>
          </div>
          
          {/* åªå…è®¸æ™®é€šåŠ¨ä½œå’Œå»¶æ—¶ï¼Œä¸å…è®¸å¾ªç¯ */}
          <ActionSection
            title="åŠ¨ä½œ"
            actions={subStep.actions}
            availableActions={filteredActions}
            onActionsChange={(actions) => onSubStepChange({...subStep, actions})}
          />
        </div>
      )}
    </div>
  );
};
```

## å»¶æ—¶ç¼–è¾‘å™¨è®¾è®¡

### å¯æŠ˜å å»¶æ—¶å®¹å™¨
```typescript
// å»¶æ—¶åŠ¨ä½œç¼–è¾‘å™¨
interface DelayEditorProps {
  delayAction: DelayAction;
  availableActions: ActionOption[];
  onDelayChange: (delayAction: DelayAction) => void;
  onDeleteDelay: () => void;
  nestingLevel: number; // åµŒå¥—å±‚çº§ï¼Œç”¨äºæ ·å¼åŒºåˆ†
}

const DelayEditor: React.FC<DelayEditorProps> = ({ 
  delayAction, availableActions, onDelayChange, onDeleteDelay, nestingLevel 
}) => {
  const [isExpanded, setIsExpanded] = useState(false); // é»˜è®¤æŠ˜å 
  
  const borderColor = nestingLevel % 2 === 0 ? 'border-purple-500' : 'border-indigo-500';
  const bgColor = nestingLevel % 2 === 0 ? 'bg-purple-50' : 'bg-indigo-50';
  
  return (
    <div className={`delay-editor border-l-4 ${borderColor} pl-4 mb-4 ${bgColor} rounded`}>
      <DelayHeader
        delayAction={delayAction}
        isExpanded={isExpanded}
        onToggleExpand={() => setIsExpanded(!isExpanded)}
        onDelayConfigChange={(config) => onDelayChange({...delayAction, ...config})}
        onDelete={onDeleteDelay}
      />
      
      {isExpanded && (
        <div className="delay-content mt-4">
          {/* å»¶æ—¶é…ç½® */}
          <DelayConfiguration
            delayMs={delayAction.delayMs}
            description={delayAction.description}
            onConfigChange={(config) => onDelayChange({...delayAction, ...config})}
          />
          
          {/* å»¶æ—¶åæ‰§è¡Œæç¤º */}
          <div className="delay-notice mb-4 p-2 bg-purple-100 rounded">
            <span className="text-purple-700">
              â° å»¶æ—¶{delayAction.delayMs}msåï¼Œä»¥ä¸‹å†…å®¹å¹¶è¡Œæ‰§è¡Œ
            </span>
          </div>
          
          {/* å»¶æ—¶å†…å®¹ï¼ˆæ”¯æŒåµŒå¥—ï¼‰ */}
          <NestedActionSection
            title="å»¶æ—¶åæ‰§è¡Œçš„å†…å®¹"
            actions={delayAction.actions}
            availableActions={availableActions}
            nestingLevel={nestingLevel + 1}
            onActionsChange={(actions) => onDelayChange({...delayAction, actions})}
          />
        </div>
      )}
    </div>
  );
};
```

## åŠ¨ä½œé€‰æ‹©å™¨è®¾è®¡

### åŠ¨æ€åŠ¨ä½œç”Ÿæˆ
```typescript
// æ ¹æ®è®¾å¤‡é…ç½®ç”ŸæˆåŠ¨ä½œé€‰é¡¹
function generateActionOptions(deviceConfigs: DeviceConfig[]): ActionOption[] {
  const options: ActionOption[] = [];
  
  // æ·»åŠ è®¾å¤‡æ§åˆ¶åŠ¨ä½œ
  deviceConfigs.forEach(device => {
    if (device.mode === 'pwm') {
      options.push({
        id: `${device.id}_power`,
        type: 'device_control',
        label: `${device.name} - åŠŸç‡æ§åˆ¶`,
        icon: 'âš¡',
        deviceId: device.id,
        actionType: 'power',
        valueType: 'number',
        valueRange: [0, device.maxPower || 100],
        unit: '%'
      });
    } else {
      options.push({
        id: `${device.id}_state`,
        type: 'device_control',
        label: `${device.name} - å¼€å…³æ§åˆ¶`,
        icon: 'ğŸ”˜',
        deviceId: device.id,
        actionType: 'state',
        valueType: 'boolean'
      });
    }
  });
  
  // æ·»åŠ é»˜è®¤å®¹å™¨åŠ¨ä½œ
  options.push(
    {
      id: 'add_loop',
      type: 'loop',
      label: 'æ·»åŠ å¾ªç¯',
      icon: 'ğŸ”„',
      description: 'åˆ›å»ºå¹¶è¡Œå¾ªç¯å®¹å™¨'
    },
    {
      id: 'add_delay',
      type: 'delay',
      label: 'æ·»åŠ å»¶æ—¶',
      icon: 'â°',
      description: 'åˆ›å»ºå»¶æ—¶å®¹å™¨'
    }
  );
  
  return options;
}

// åŠ¨ä½œé€‰æ‹©å™¨ç»„ä»¶
interface ActionSelectorProps {
  availableActions: ActionOption[];
  onActionSelect: (actionType: string) => void;
  allowedTypes?: string[]; // å…è®¸çš„åŠ¨ä½œç±»å‹ï¼ˆç”¨äºå­æ­¥éª¤é™åˆ¶ï¼‰
}

const ActionSelector: React.FC<ActionSelectorProps> = ({ 
  availableActions, onActionSelect, allowedTypes 
}) => {
  const filteredActions = allowedTypes 
    ? availableActions.filter(action => allowedTypes.includes(action.type))
    : availableActions;
  
  return (
    <div className="action-selector grid grid-cols-2 md:grid-cols-3 gap-2">
      {filteredActions.map(action => (
        <button
          key={action.id}
          onClick={() => onActionSelect(action.type)}
          className="action-option p-3 border rounded-lg hover:bg-gray-50 text-left"
        >
          <div className="flex items-center space-x-2">
            <span className="text-xl">{action.icon}</span>
            <div>
              <div className="font-medium text-sm">{action.label}</div>
              {action.description && (
                <div className="text-xs text-gray-500">{action.description}</div>
              )}
            </div>
          </div>
        </button>
      ))}
    </div>
  );
};
```

## å®æ—¶éªŒè¯ç³»ç»Ÿ

### ç¼–è¾‘æ—¶éªŒè¯
```typescript
// å®æ—¶éªŒè¯hook
function useTaskValidation(task: Task, deviceConfigs: DeviceConfig[]) {
  const [errors, setErrors] = useState<ValidationError[]>([]);
  const [warnings, setWarnings] = useState<ValidationWarning[]>([]);
  
  useEffect(() => {
    const validationResult = validateTask(task, deviceConfigs);
    setErrors(validationResult.errors);
    setWarnings(validationResult.warnings);
  }, [task, deviceConfigs]);
  
  return { errors, warnings, isValid: errors.length === 0 };
}

// éªŒè¯é¢æ¿ç»„ä»¶
interface ValidationPanelProps {
  errors: ValidationError[];
  warnings: ValidationWarning[];
}

const ValidationPanel: React.FC<ValidationPanelProps> = ({ errors, warnings }) => {
  if (errors.length === 0 && warnings.length === 0) {
    return (
      <div className="validation-panel p-3 bg-green-50 border border-green-200 rounded">
        <span className="text-green-700">âœ… ä»»åŠ¡é…ç½®æœ‰æ•ˆ</span>
      </div>
    );
  }
  
  return (
    <div className="validation-panel space-y-2">
      {errors.map((error, index) => (
        <div key={index} className="error p-3 bg-red-50 border border-red-200 rounded">
          <span className="text-red-700">âŒ {error.message}</span>
        </div>
      ))}
      {warnings.map((warning, index) => (
        <div key={index} className="warning p-3 bg-yellow-50 border border-yellow-200 rounded">
          <span className="text-yellow-700">âš ï¸ {warning.message}</span>
        </div>
      ))}
    </div>
  );
};
```

## æ€»ç»“

å‰ç«¯ç¼–è¾‘å™¨æ¨¡å—çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. **ç›´è§‚çš„å¯è§†åŒ–ç¼–è¾‘** - æ¸…æ™°çš„æŠ˜å /å±•å¼€ç•Œé¢
2. **ä¸¥æ ¼çš„é€»è¾‘æ§åˆ¶** - å‰ç«¯å±‚é¢é˜²æ­¢é”™è¯¯åµŒå¥—
3. **åŠ¨æ€å†…å®¹ç”Ÿæˆ** - æ ¹æ®è®¾å¤‡é…ç½®è‡ªåŠ¨ç”Ÿæˆé€‰é¡¹
4. **å®æ—¶éªŒè¯åé¦ˆ** - ç¼–è¾‘è¿‡ç¨‹ä¸­å³æ—¶å‘ç°é—®é¢˜
5. **ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ** - æ¸…æ™°çš„ä¸²è¡Œ/å¹¶è¡Œå…³ç³»æç¤º
6. **çµæ´»çš„åµŒå¥—æ”¯æŒ** - æ”¯æŒå»¶æ—¶å®¹å™¨çš„å¤šå±‚åµŒå¥—

è¿™ä¸ªç¼–è¾‘å™¨ç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿè½»æ¾åˆ›å»ºå¤æ‚çš„ä»»åŠ¡ç¼–æ’ï¼ŒåŒæ—¶é¿å…é€»è¾‘é”™è¯¯ã€‚
